!function(){"use strict";ko.components.register("google-map",{viewModel:{createViewModel:function(a,b){function c(a,b){return google?(this.preload(),this.elementContainer=b,this.map=new google.maps.Map(b.querySelector("#map"),{center:new google.maps.LatLng(a.center[0],a.center[1]),zoom:a.zoom,disableDefaultUI:a.disableDefaultUI}),this.places=a.places,this.bindMapListeners(),void this.showPlaces(this.places())):!1}c.prototype={constructor:c,hidePlaces:function(a){_.forEach(a,function(a){a.setMap(null)})},showPlaces:function(a){_.forEach(a,function(a){a.setMap(this.map)},this)},getMap:function(){return this.map},preload:function(){this.loading=ko.observable(!0)},loadComplete:function(){this.loading(!1)},animateOnShow:function(){$(this.elementContainer).velocity({translateY:[0,"-100%"]},{easing:[1e3,20],duration:500})},bindMapListener:function(a,b){return google.maps.event.addListener(this.getMap(),a,function(){b.call(this)}.bind(this))},unbindMapListener:function(a){google.maps.event.removeListener(a)},unbindMapLoadListener:function(){this.unbindMapListener(this.mapLoadListener)},bindMapLoadListener:function(){this.mapLoadListener=this.bindMapListener("tilesloaded",function(){this.loadComplete(),this.animateOnShow(),this.unbindMapLoadListener()})},bindMapListeners:function(){this.loadListener=this.bindMapLoadListener()},getDOMNode:function(){return this.elementContainer}};var d=new c(a,b.element);return d.places.subscribe(function(a){d.showPlaces(a)}),d.places.subscribe(function(a){d.hidePlaces(a)},null,"beforeChange"),$(d.getDOMNode()).trigger("map.initialized",{map:d.getMap()}),d}},template:{element:"google-map.html"}})}(),function(a){"use strict";function b(a){var b,c=d.length;for(b=0;c>b;b+=1)if(a===d[b])return!0;return!1}function c(a,b){var c=this;c.location=a.geometry.location,c.title=a.name,c.types=a.types,c.vicinity=a.vicinity,c.ctrl=b,c.googleReference=a.reference,c.errors=ko.observableArray([]),c.marker=c.createMarker()}var d=["bar","restaurant","bakery","gym","book_store","cafe","hair_care"];c.prototype={constructor:c,setMap:function(a){this.marker.setMap(a)},getIconUrl:function(){var a,c=this.types,d=c.length;for(a=0;d>a;a+=1)if(b(c[a]))return"img/"+c[a]+".png";return"img/default.png"},createMarker:function(){var a=new google.maps.Marker({position:this.createPosition(),map:null,title:this.title,icon:{url:this.getIconUrl()}});return google.maps.event.addListener(a,"click",function(){this.ctrl.goToPlace(this)}.bind(this)),a},createPosition:function(){return this.location},animateMarker:function(){this.marker.setAnimation(google.maps.Animation.BOUNCE)},stopAnimatingMarker:function(){this.marker.setAnimation(null)},getDetailsRequest:function(){return{reference:this.googleReference}}},ko.components.register("place",{viewModel:{createViewModel:function(a){function b(){this.place=a.place}return new b}},template:{element:"place.html"}}),ko.bindingHandlers.hasHighlightableMarker={init:function(a,b){var c=b();a.addEventListener("mouseenter",c.animateMarker.bind(c)),a.addEventListener("mouseleave",c.stopAnimatingMarker.bind(c)),ko.utils.domNodeDisposal.addDisposeCallback(a,c.stopAnimatingMarker.bind(c))}},ko.components.register("places-list",{viewModel:{createViewModel:function(a){function b(){this.places=a.places}return new b}},template:{element:"places-list.html"}}),ko.components.register("place-reviews",{viewModel:{createViewModel:function(a){function b(){var b=a.api;this.place=a.place,this.errors=ko.observableArray([]),this.reviews=ko.observableArray([]),b.getDetails(this.place.getDetailsRequest(),this.handleReviews.bind(this))}return b.prototype={constructor:b,handleReviews:function(a,b){b===google.maps.places.PlacesServiceStatus.OK?this.reviews(a.reviews):this.errors.push("Unable to get reviews")}},new b}},template:{element:"place-reviews.html"}}),a.Place=c}(this),function(a){"use strict";function b(a){this.param=a,this.delimiter=","}function c(a){b.call(this,a),this.delimiter="|"}function d(a){a instanceof google.maps.LatLng?b.call(this,[a.lat(),a.lng()]):b.call(this,a)}function e(a){var b={format:"json"};this.BASE_URL="https://maps.googleapis.com/maps/api",this.options=_.assign(b,this.buildOptions(a))}function f(a){var b=_.assign({},a);e.call(this,b),this.BASE_URL+="/place"}function g(){var a={size:"600x200",sensor:!1,format:"streetview"};e.call(this,a)}b.prototype={constructor:b,toString:function(){return this.param.join(this.delimiter)}},c.prototype=Object.create(b.prototype),c.prototype.constructor=c,d.prototype=Object.create(b.prototype),d.prototype.constructor=d,e.prototype={constructor:e,buildOptions:function(a){var b={location:d,types:c};return _.mapValues(a,function(a,c){return b.hasOwnProperty(c)?new b[c](a):a})},buildParamString:function(a,b){return b+"="+a.toString()},buildParamsString:function(a){return"?"+_.map(a,this.buildParamString,this).join("&")},buildQuery:function(a,b){return _.compact([this.BASE_URL,a,b.format]).join("/")+this.buildParamsString(b)},ajaxCall:function(a){return $.getJSON(a)},setLocation:function(a){this.options.location=new d(a)}},f.prototype=Object.create(e.prototype),_.assign(f.prototype,{constructor:f,nearbySearch:function(){var a=this.options;return this.ajaxCall(this.buildQuery("nearbysearch",a))},getPlaceDetails:function(a){var b=_.assign({reference:a.googleReference},this.options);return this.ajaxCall(this.buildQuery("details",b))}}),g.prototype=Object.create(e.prototype),_.assign(g.prototype,{constructor:g,getImageUrlFor:function(a){return this.setLocation(a.location),this.buildQuery("",this.options)}}),a.StreetView=g,a.GooglePlaces=f}(this),function(){"use strict";function a(a){var b=this;this.placesRequestOptions=a,this.allPlaces=[],this.filteredPlaces=ko.observableArray([]),this.selectedPlace=ko.observable(null),this.searchQuery=ko.observable(),this.errors=ko.observableArray([]),this.anyErrors=ko.computed(function(){return b.errors().length>0}),this.searchQuery.subscribe(this.filterPlaces,this),this.searchQuery.extend({rateLimit:100}),this.listenForMap(),google||this.errors.push("Unable to connect to Google services..."),StreetView||this.errors.push("Unable to connect to Street View..."),Flickr||this.errors.push("Flickr is unavailable"),this.streetViewAPI=new StreetView,this.flickr=new Flickr({api_key:"9e8a6545901694042e736b9a878e2a92"})}function b(){var b={location:new google.maps.LatLng(45.039717,38.974496),radius:1e3,types:["bar","bakery","book_store","cafe","food","gym","hair_care"]};ko.components.register("street-view",{viewModel:{createViewModel:function(a){function b(){var b=a.api;this.place=a.place,this.posterUrl=ko.observable(b.getImageUrlFor(this.place))}return new b}},template:{element:"street-view.html"}}),ko.components.register("flickr",{viewModel:{createViewModel:function(a){function b(){var b,c,d,e=a.api,f=this;b=a.place,f.photos=ko.observableArray([]),c=b.types.join(","),d=b.location.lat(),e.photos.search({lat:d,tags:c,per_page:10},function(a,b){a||f.photos(b.photos.photo)})}return new b}},template:{element:"flickr.html"}}),ko.components.register("flickr-image",{viewModel:{createViewModel:function(a){function b(){var b=(a.api,a.photo);this.url=["https://farm",b.farm,".staticflickr.com/",b.server,"/",b.id,"_",b.secret,"_q.jpg"].join("")}return new b}},template:{element:"flickr-image.html"}}),ko.components.register("errors",{viewModel:{createViewModel:function(a,b){function c(){this.errors=a.errors,a.modal&&$(b.element).addClass("modal")}return new c}},template:{element:"errors.html"}}),ko.bindingHandlers.date={init:function(a,b){var c=new Date(1e3*b());$(a).text(c.toDateString())}},ko.applyBindings(new a(b))}a.prototype={constructor:a,populatePlaces:function(a,b){if(b===google.maps.places.PlacesServiceStatus.OK){var c=this.createPlacesFromJSON(a);this.allPlaces=c,this.filteredPlaces(c)}else this.errors.push("Unable to get places")},loadPlaces:function(a){this.placesAPI=new google.maps.places.PlacesService(a),this.placesAPI.search(this.placesRequestOptions,this.populatePlaces.bind(this))},mapInitialized:function(a,b){this.loadPlaces(b.map)},listenForMap:function(){$(document).on("map.initialized",this.mapInitialized.bind(this))},goToPlace:function(a){this.selectedPlace(a)},getOut:function(){this.selectedPlace(null)},placeFilter:function(a,b){var c=b.toLowerCase();return a.title.toLowerCase().search(c)>-1||_.contains(a.types,c)},filterPlaces:function(a){this.filteredPlaces(_.filter(this.allPlaces,function(b){return this.placeFilter(b,a)},this))},createPlacesFromJSON:function(a){return _.map(a,function(a){return new Place(a,this)},this)}},document.addEventListener("DOMContentLoaded",b)}();